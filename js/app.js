angular.module("deviceApp",["storage","ngRoute","dozuki"]).config(["$routeProvider",function($routeProvider){$routeProvider.when("/",{controller:"DeviceCollectionController as devices",templateUrl:"view/collection.html",resolve:{deviceList:["PersistentList",function(PersistentList){return PersistentList("devices",function(item){return{wikiid:item.wikiid,title:item.title}})}]}}).otherwise({redirectTo:"/"})}]).controller("DeviceCollectionController",["deviceList","Dozuki","$location","$scope",function(deviceList,Dozuki,$location,$scope){var controller=this;var dozuki=Dozuki("www.ifixit.com");var initialize=function(){setViewModel(deviceList.getArray());controller.results=[];runSearchQuery()};var runSearchQuery=function(){controller.searchQuery=$location.search().q;controller.isSearching=false;if(controller.searchQuery){controller.isSearching=true;dozuki.suggest.get(controller.searchQuery,"device",10,0).then(function(response){controller.results=response.results},function(){})}};var setViewModel=function(list){controller.viewModelList=list;controller.viewModelSet={};list.forEach(function(item,index){controller.viewModelSet[""+item.wikiid]=true})};controller.add=function(result){deviceList.insert({wikiid:result.wikiid,title:result.title}).save().then(setViewModel)};controller.remove=function(index){deviceList.remove(index).save().then(setViewModel)};controller.removeById=function(wikiid){var index;if(controller.viewModelList.some(function(item,i){if(item.wikiid==wikiid){index=i;return true}return false})){controller.remove(index)}};controller.search=function(query){$location.search({q:query})};controller.endSearch=function(){$location.search({q:null})};initialize()}]);angular.module("dozuki",[]).factory("Dozuki",["$window","$http",function($window,$http){var Wrapper=function(){this.send=function(url,options){var httpOptions={url:url,method:options.method,headers:options.headers};httpOptions[options.method=="GET"?"data":"params"]=options.data;return $http(httpOptions).then(function(response){return response.data})}};return function(domain){return new $window.Dozuki(domain,new Wrapper)}}]);angular.module("storage",[]).factory("PersistentList",["$q","$window",function($q,$window){var storage;try{storage=$window.localStorage,x="__storage_test__";storage.setItem(x,x);storage.removeItem(x)}catch(e){storage={}}var List=function(name,toJSON){this.name="PersistentList_"+name;this.itemToJSON=toJSON;this.data=[]};List.prototype.getArray=function(){return this.data.slice()};List.prototype.setData=function(data){var list=this;data.forEach(function(item){item.toJSON=list.itemToJSON});this.data=data};List.prototype.insert=function(item,index){item.toJSON=this.itemToJSON;this.data.splice(index||this.data.length,0,item);return this};List.prototype.remove=function(index){this.data.splice(index,1);return this};List.prototype.save=function(){storage[this.name]=$window.JSON.stringify(this.data);return $q.resolve(this.getArray())};return function(name){var list=new List(name);try{list.setData($window.JSON.parse(storage[list.name]))}catch(e){}return $q.resolve(list)}}]);